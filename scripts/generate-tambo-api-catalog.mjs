import fs from "node:fs";
import path from "node:path";

const rootDir = process.cwd();
const apiRoot = path.join(rootDir, "src", "app", "api");
const outputFile = path.join(
  rootDir,
  "src",
  "lib",
  "tambo",
  "api-catalog.generated.ts"
);

const METHOD_ORDER = ["GET", "POST", "PUT", "PATCH", "DELETE"];

const routeDescriptionOverrides = new Map([
  ["/api/admin/couriers", "Couriers list/create/update (PATCH requires courierId)."],
  ["/api/admin/low-admins/[id]", "Update low admin/courier fields (includes salary)."],
  ["/api/admin/finance/salary", "Pay salary transaction."],
  ["/api/orders", "Orders list/create."],
  ["/api/orders/[orderId]", "Order details/update."],
  ["/api/admin/statistics", "Admin dashboard statistics."],
]);

function walk(dir) {
  const entries = fs.readdirSync(dir, { withFileTypes: true });
  const result = [];
  for (const entry of entries) {
    const absolutePath = path.join(dir, entry.name);
    if (entry.isDirectory()) {
      result.push(...walk(absolutePath));
      continue;
    }
    if (entry.isFile() && entry.name === "route.ts") {
      result.push(absolutePath);
    }
  }
  return result;
}

function toApiPath(routeFile) {
  const routeDir = path.dirname(routeFile);
  const relative = path.relative(apiRoot, routeDir);
  const normalized = relative.split(path.sep).filter(Boolean).join("/");
  return normalized.length > 0 ? `/api/${normalized}` : "/api";
}

function extractMethods(fileContent) {
  const regex = /export\s+async\s+function\s+(GET|POST|PUT|PATCH|DELETE)\s*\(/g;
  const methods = new Set();
  for (const match of fileContent.matchAll(regex)) {
    methods.add(match[1]);
  }
  return METHOD_ORDER.filter((method) => methods.has(method));
}

function defaultDescription(apiPath, methods) {
  const tail = apiPath.split("/").filter(Boolean).slice(-1)[0] ?? "route";
  const label = tail.startsWith("[") ? "dynamic route" : tail.replace(/-/g, " ");
  return `${label} endpoint (${methods.join("/")}).`;
}

if (!fs.existsSync(apiRoot)) {
  throw new Error(`API directory not found: ${apiRoot}`);
}

const routeFiles = walk(apiRoot);
const items = routeFiles
  .map((routeFile) => {
    const content = fs.readFileSync(routeFile, "utf8");
    const methods = extractMethods(content);
    if (methods.length === 0) return null;
    const apiPath = toApiPath(routeFile);
    const description =
      routeDescriptionOverrides.get(apiPath) ?? defaultDescription(apiPath, methods);
    return { path: apiPath, methods, description };
  })
  .filter(Boolean)
  .sort((a, b) => a.path.localeCompare(b.path));

const catalog = [
  {
    path: "/api/*",
    methods: METHOD_ORDER,
    description:
      "Generic caller: any existing /api route can be requested with site_api_request.",
  },
  ...items,
];

const output = `// AUTO-GENERATED by scripts/generate-tambo-api-catalog.mjs
// Do not edit manually. Re-run: node scripts/generate-tambo-api-catalog.mjs

export const SITE_ENDPOINT_CATALOG = ${JSON.stringify(catalog, null, 2)} as const;
`;

fs.writeFileSync(outputFile, output, "utf8");
console.log(`Generated ${path.relative(rootDir, outputFile)} with ${catalog.length} endpoints.`);
