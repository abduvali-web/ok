import fs from "node:fs";
import path from "node:path";

const rootDir = process.cwd();
const componentsRoot = path.join(rootDir, "src", "components");
const appRoot = path.join(rootDir, "src", "app");
const outputFile = path.join(
  rootDir,
  "src",
  "lib",
  "tambo",
  "ui-catalog.generated.ts"
);

function walk(dir, matcher) {
  const result = [];
  const entries = fs.readdirSync(dir, { withFileTypes: true });
  for (const entry of entries) {
    const absolutePath = path.join(dir, entry.name);
    if (entry.isDirectory()) {
      result.push(...walk(absolutePath, matcher));
      continue;
    }
    if (entry.isFile() && matcher(absolutePath)) {
      result.push(absolutePath);
    }
  }
  return result;
}

function toPosix(value) {
  return value.split(path.sep).join("/");
}

function toComponentName(filePath) {
  const base = path.basename(filePath, path.extname(filePath));
  if (base === "index") {
    return path.basename(path.dirname(filePath));
  }
  return base;
}

function toPurposeFromPath(relativePath) {
  const cleaned = relativePath
    .replace(/\.[tj]sx?$/i, "")
    .replace(/\//g, " ")
    .replace(/[-_]/g, " ")
    .trim();
  return `UI component from ${cleaned}`;
}

function toRoutePath(pageFile) {
  const pageDir = path.dirname(pageFile);
  const relative = path.relative(appRoot, pageDir);
  const segments = relative
    .split(path.sep)
    .filter(Boolean)
    .filter((segment) => !segment.startsWith("("))
    .filter((segment) => !segment.startsWith("@"));
  if (segments.length === 0) return "/";
  return `/${segments.join("/")}`;
}

const uiComponentFiles = fs.existsSync(componentsRoot)
  ? walk(
      componentsRoot,
      (absolutePath) =>
        absolutePath.endsWith(".tsx") || absolutePath.endsWith(".ts")
    )
  : [];

const pageFiles = fs.existsSync(appRoot)
  ? walk(appRoot, (absolutePath) => absolutePath.endsWith(`${path.sep}page.tsx`))
  : [];

const uiComponents = Array.from(
  new Map(
    uiComponentFiles.map((filePath) => {
      const relativePath = toPosix(path.relative(path.join(rootDir, "src"), filePath));
      const componentName = toComponentName(filePath);
      return [
        `${componentName}|${relativePath}`,
        {
          name: componentName,
          purpose: toPurposeFromPath(relativePath),
          source: relativePath,
        },
      ];
    })
  ).values()
).sort((a, b) => a.name.localeCompare(b.name));

const pages = Array.from(
  new Map(
    pageFiles.map((pageFile) => {
      const routePath = toRoutePath(pageFile);
      return [
        routePath,
        {
          path: routePath,
          purpose: `Interactive page at ${routePath}`,
        },
      ];
    })
  ).values()
).sort((a, b) => a.path.localeCompare(b.path));

const output = `// AUTO-GENERATED by scripts/generate-tambo-ui-catalog.mjs
// Do not edit manually. Re-run: node scripts/generate-tambo-ui-catalog.mjs

export const SITE_UI_COMPONENT_CATALOG = ${JSON.stringify(uiComponents, null, 2)} as const;

export const SITE_UI_PAGE_CATALOG = ${JSON.stringify(pages, null, 2)} as const;
`;

fs.writeFileSync(outputFile, output, "utf8");
console.log(
  `Generated ${path.relative(rootDir, outputFile)} with ${uiComponents.length} components and ${pages.length} pages.`
);
